name: Rust

on:
  push: # Comment this line to trigger action only on pull-requests (not recommended if you don't pay for GH Actions)
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: rustup update nightly
      - run: rustup default nightly
      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          cache-targets: "false"
      - name: Run database
        run: docker-compose -f docker/test/docker-compose.yml up --build -d
      - run: cargo build --all-targets
        env: # required variables according to https://github.com/mozilla/grcov
          CARGO_INCREMENTAL: 0
          RUSTFLAGS: "-Zprofile -Ccodegen-units=1 -Copt-level=0 -Clink-dead-code -Coverflow-checks=off -Zpanic_abort_tests -Cpanic=abort"
          RUSTDOCFLAGS: "-Cpanic=abort"
      - name: Run unit tests
        run: cargo test
      - name: Run service instance
        env:
          CUSTOM_DOMAIN: example.com
          DYNAMODB_TABLE: table_name
          LOCAL_DYNAMODB_URL: http://localhost:8000
          REGION: eu-west-1
        run: ./target/debug/rust_lambda &
      - name: Run integration tests
        run: ./target/debug/examples/test http://localhost:8080
        env:
          LOCAL_DYNAMODB_URL: "http://localhost:8000"
      - uses: actions-rs/grcov@v0.1.6
      - uses: codecov/codecov-action@v3.1.1
